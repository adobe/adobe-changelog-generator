const TemplateEngine = require('../../src/services/template-engine');
const templateEngine = new TemplateEngine();
const template =
`<!--repeat_namespaces-->
{{namespace}}
=============
<!--repeat_releases-->
## {{tag}} ({{created_at|date_format:dd-MM-yy}}) {{repository}} or {{organization}} or {{branch}}
<!--repeat_contributionTypes-->
### {{contribution_type}}
<!--repeat_items-->
* [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}})
-- {{title}} by [@{{author}}](https://github.com/{{author}})
<!--repeat_items_end-->
<!--repeat_contributionTypes_end-->
<!--repeat_releases_end-->
<!--repeat_namespaces_end-->`;

const template01 = `
<!--repeat_namespaces|scope_content-->
{{namespace|namespace_format:short|capitalize}}
=============
<!--repeat_releases-->
## {{tag}}
| Partner | Pull Requests | Related GitHub Issues |
| ------- | ------- | ------- |
<!--repeat_groupByItems-->| {{group_by}} | <!--repeat_items--> [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) <!--repeat_items_end--> | <!--repeat_items--><!--repeat_crossreferences--> [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) <!--repeat_crossreferences_end--><!--repeat_items_end--> |
<!--repeat_groupByItems_end-->
<!--repeat_releases_end-->
<!--repeat_namespaces_end-->`;
const template01ParsedTemplateTree = [{"template":"\\n<placeholder-repeat-0>","type":"top","inside":[{"type":"namespaces","template":"\\n{{namespace|namespace_format:short|capitalize}}\\n=============\\n<placeholder-repeat-0>\\n","inside":[{"type":"releases","template":"\\n## {{tag}}\\n| Partner | Pull Requests | Related GitHub Issues |\\n| ------- | ------- | ------- |\\n<placeholder-repeat-0>\\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]}]}];
const template01ParsedTemplateTreeString = `[{"template":"\\n<placeholder-repeat-0>","type":"top","inside":[{"type":"namespaces","template":"\\n{{namespace|namespace_format:short|capitalize}}\\n=============\\n<placeholder-repeat-0>\\n","inside":[{"type":"releases","template":"\\n## {{tag}}\\n| Partner | Pull Requests | Related GitHub Issues |\\n| ------- | ------- | ------- |\\n<placeholder-repeat-0>\\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]}]}]`;
const evaluated01TemplateTree = [{"evaluatedTemplate":"<placeholder-repeat-0>\n\n\n","type":"top","repeatIndex":0,"item":{"template":"<placeholder-repeat-0>\n\n\n","type":"top","inside":[{"type":"namespaces","template":"\n{{namespace|namespace_format:short|capitalize}}\n=============\n<placeholder-repeat-0>\n","inside":[{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]}]},"inside":[{"evaluatedTemplate":"\nMagento2\n=============\n<placeholder-repeat-0>\n","type":"namespaces","repeatIndex":0,"item":{"type":"namespaces","template":"\n{{namespace|namespace_format:short|capitalize}}\n=============\n<placeholder-repeat-0>\n","inside":[{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]},"inside":[{"evaluatedTemplate":"\n## 2.4.3\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","type":"releases","repeatIndex":0,"item":{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]},"inside":[{"evaluatedTemplate":"|  Atwix | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","type":"groupByItems","repeatIndex":0,"item":{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]},"inside":[{"evaluatedTemplate":" [magento/magento2#33043](https://github.com/magento/magento2/pull/33043) ","type":"items","repeatIndex":0,"item":{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "}},{"evaluatedTemplate":" [magento/magento2#32947](https://github.com/magento/magento2/pull/32947) ","type":"items","repeatIndex":0,"item":{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "}},{"evaluatedTemplate":" [magento/magento2#32936](https://github.com/magento/magento2/pull/32936) ","type":"items","repeatIndex":0,"item":{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "}},{"evaluatedTemplate":"<placeholder-repeat-0>","type":"items","repeatIndex":1,"item":{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]},"inside":[{"evaluatedTemplate":" [magento/magento2#32913](https://github.com/magento/magento2/issues/32913) ","type":"crossreferences","repeatIndex":0,"item":{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}}]},{"evaluatedTemplate":"<placeholder-repeat-0>","type":"items","repeatIndex":1,"item":{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]},"inside":[{"evaluatedTemplate":" [magento/merchdocs#1204](https://github.com/magento/merchdocs/issues/1204) ","type":"crossreferences","repeatIndex":0,"item":{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}}]},{"evaluatedTemplate":"<placeholder-repeat-0>","type":"items","repeatIndex":1,"item":{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]},"inside":[]}]}]}]},{"evaluatedTemplate":"\nPartners-magento2ee\n=============\n<placeholder-repeat-0>\n","type":"namespaces","repeatIndex":0,"item":{"type":"namespaces","template":"\n{{namespace|namespace_format:short|capitalize}}\n=============\n<placeholder-repeat-0>\n","inside":[{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]},"inside":[{"evaluatedTemplate":"\n## 2.4.4\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","type":"releases","repeatIndex":0,"item":{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]},"inside":[]}]},{"evaluatedTemplate":"\nPartners-magento2b2b\n=============\n<placeholder-repeat-0>\n","type":"namespaces","repeatIndex":0,"item":{"type":"namespaces","template":"\n{{namespace|namespace_format:short|capitalize}}\n=============\n<placeholder-repeat-0>\n","inside":[{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]}]},"inside":[{"evaluatedTemplate":"\n## 1.3.3\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","type":"releases","repeatIndex":0,"item":{"type":"releases","template":"\n## {{tag}}\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n<placeholder-repeat-0>\n","inside":[{"type":"groupByItems","template":"| {{group_by}} | <placeholder-repeat-0> | <placeholder-repeat-1> |\n","inside":[{"type":"items","template":" [{{organization}}/{{repository}}#{{number}}](https://github.com/{{organization}}/{{repository}}/pull/{{number}}) "},{"type":"items","template":"<placeholder-repeat-0>","inside":[{"type":"crossreferences","template":" [{{reference_organization}}/{{reference_repository}}#{{reference_number}}](https://github.com/{{reference_organization}}/{{reference_repository}}/issues/{{reference_number}}) "}]}]}]},"inside":[]}]}]}];
const generatedTemplateString = "\nMagento2\n=============\n\n## 2.4.3\n| Partner | Pull Requests | Related GitHub Issues |\n| ------- | ------- | ------- |\n|  Atwix |  [magento/magento2#33043](https://github.com/magento/magento2/pull/33043)  [magento/magento2#32947](https://github.com/magento/magento2/pull/32947)  [magento/magento2#32936](https://github.com/magento/magento2/pull/32936)  |  [magento/magento2#32913](https://github.com/magento/magento2/issues/32913)  [magento/merchdocs#1204](https://github.com/magento/merchdocs/issues/1204)  |\n\n\n\nPartners-magento2ee\n=============\n\n\nPartners-magento2b2b\n=============\n\n\n\n\n";


describe('findRepeat', () => {
    it('Successfully find top level repeat', async () => {
        const repeatPart = await templateEngine.findRepeat(template);
        expect(repeatPart.template).toBeTruthy();
        expect(repeatPart.startRepeatIndexFrom).toBe(0);
        expect(repeatPart.startRepeatIndexTo).toBe(24);
    })
})

describe('getTemplateForRepeats', () => {
    it('Successfully parse template', async () => {
        const parsedTemplateTree = templateEngine.getTemplateForRepeats({template: template01, type: 'top'});
        const parsedTemplateTreeString = JSON.stringify(parsedTemplateTree);
        expect(parsedTemplateTreeString).toBeTruthy();
        expect(parsedTemplateTreeString).toStrictEqual(template01ParsedTemplateTreeString);
    })
})

describe('getEvaluatedStringByEvaluatedTree', () => {
    it('Successfully generate template', async () => {
        const generatedTemplate = templateEngine.getEvaluatedStringByEvaluatedTree(evaluated01TemplateTree);
        expect(generatedTemplateString).toStrictEqual(generatedTemplate);
    })
})

